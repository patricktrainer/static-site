
    <!DOCTYPE html>
    <html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width">
            <title>DISTINCT ON The confusing, unique and useful featu e430de86b18242feac7c1d29bc3f5044</title>
            
            
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/open-fonts@1.1.1/fonts/inter.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css">
    <link rel="stylesheet" href="https://unpkg.com/github-syntax-dark@latest/lib/github-dark.css"/>
    
        </head>
        <body>
            <header>
                <nav>
                    <a href="https://patricktrainer.github.io/static-site">Home</a> /
                    <a href="https://github.com/patricktrainer">GitHub</a> / 
                </nav>
            </header>
            <h1>DISTINCT ON: The confusing, unique and useful feature in Postgres - Blog by Yogesh Chauhan</h1>
<p>Created: Mar 21, 2020 10:04 AM
URL: https://www.yogeshchauhan.com/167/postgres/the-confusing-unique-and-useful-feature-in-postgres-distinct-on</p>
<p>We saw how DISTINCT works at the end of this post: <a href="https://www.yogeshchauhan.com/165/postgres/select-statement-in-postgres-with-examples">Select Statement In Postgres With Examples</a></p>
<p>Let's explore it further.</p>
<p>When I saw DISTINCT ON, I was like, there must not be anything new about it, you know, just another similar kind of feature with a different name. But I was wrong! It seems very powerful feature to me at least!</p>
<p>What I did was nothing special. Googled it and went through tons of articles. Most of them are filled with the official documentation but not the simple explanation and some of them are with nice decent explanation. I couldn't understand most of it, to be frank. I was wondering why the feature is so hard to get hold of! So, I tried to play with it and find out more about it. Before I show some of my findings let's just go through some crappy theory first!</p>
<p><strong>As per the official documentation, SELECT DISTINCT ON ( expression [, ...] ) keeps only the first row of each set of rows where the given expressions evaluate to equal.</strong></p>
<blockquote>
<p>In simple terms, if we sue DISTINCT ON then it will give us the first result from the set of results which are grouped together.</p>
</blockquote>
<p><em>Now the question is, when did we group them? We just simply use DISTINCT ON.</em> Well, with DISTINCT ON, we just want PostgreSQL to return <strong>a single row for each distinct group</strong> <strong>defined by the ON clause.</strong></p>
<blockquote>
<p>The DISTINCT ON clause will only return the first row based on the DISTINCT ON(column) and ORDER BY clause provided in the query. For other columns, it will return the corresponding values. Basically, it LIMITs 1 by default when we use DISTINCT ON.</p>
</blockquote>
<p>The DISTINCT ON expressions are interpreted using the same rules as for ORDER BY. That means we can decide what row we want in our results- but by only ascending and descending the columns.</p>
<p>Note that the "first row" of each set is unpredictable unless ORDER BY is used to ensure that the desired row appears first. That means the results will be different if we don't use ORDER BY as Postgres is not smart enough to know our minds! The results will not be in order basically. For example,</p>
<p>Above example is from official documentation. Now, we are not adding ORDER BY clause in it and that's why we don't know which of the rows will be selected. If we add, ORDER BY like the following example, we can be sure of a specific row.</p>
<p><code>SELECT DISTINCT ON (location) location, time, report
FROM weather_reports
ORDER BY location, time DESC;</code></p>
<p>The query retrieves the most recent weather report for each location.</p>
<p>Now, let's just take a few more examples.</p>
<h3>Is there any difference between the results of DISTINCT and DISTINCT ON queries?</h3>
<p>Yes, there is. That's why they have both! Take a look at the queries and results below.</p>
<p>Simple DISTINCT query:</p>
<p>Output:</p>
<p><img alt="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-1.jpg" src="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-1.jpg" /></p>
<p>DISTINCT ON query:</p>
<p>Output:</p>
<p><img alt="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-2.jpg" src="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-2.jpg" /></p>
<p><img alt="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-3.jpg" src="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-3.jpg" /></p>
<p>What about adding ORDER BY?</p>
<p><code>SELECT DISTINCT ON (country) contact_name, country, company_name FROM customers 
ORDER BY country;</code></p>
<p>Output:</p>
<p><img alt="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-4.jpg" src="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-4.jpg" /></p>
<p>There is no difference between the outputs from the previous and the current query. That's because Postgres is showing results in ASC (Ascending) order by default.</p>
<h3>Let's try DSC (Descending) order.</h3>
<p><code>SELECT DISTINCT ON (country) contact_name, country, company_name FROM customers 
ORDER BY country DESC;</code></p>
<p>Output:</p>
<p><img alt="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-5.jpg" src="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-5.jpg" /></p>
<p>As we can see, the results are completely different. So, when we use thie DISTINCT ON, we need to be careful what we want in our results.</p>
<p>Now, by this point, we know that it acts like GROUP BY.</p>
<h3>Then, why do we need GROUP BY in Postgres?</h3>
<p>Well, let's understand that by queries.</p>
<p>The query above will raise an error as we are not using COUNT or any other aggregate functions as well as we are not adding all the columns to the GROUP BY clause. So, one of those options we need to choose. Either add aggregate function or add all columns to the GROUP BY clause.</p>
<p>The screenshot of the error:</p>
<p><img alt="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-6.jpg" src="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-6.jpg" /></p>
<p>So, if we add all the columns to the GROUP BY clause then we will basically get the same results as just simple DISTINCT query.</p>
<p><code>SELECT country, contact_name, company_name FROM customers 
GROUP BY country, contact_name, company_name;</code></p>
<p>Output:</p>
<p><img alt="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-7.jpg" src="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-7.jpg" /></p>
<p>We can not add an aggregate function to just one column. Take a look at the query and results below.</p>
<p><img alt="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-8.jpg" src="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-8.jpg" /></p>
<p>So, we need to write down query like this:</p>
<p>SELECT country, COUNT(contact_name), COUNT(company_name) FROM customers GROUP BY country;</p>
<p>Output:</p>
<p><img alt="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-9.jpg" src="DISTINCT%20ON%20The%20confusing,%20unique%20and%20useful%20featu%20e430de86b18242feac7c1d29bc3f5044/distinct-on-query-output-yogesh-chauhan-9.jpg" /></p>
<p>So, as we can see in the screenshot above, we are getting the number of rows using GROUP BY but if we want the first result from all those groups, we need to use DISTINCT ON and that's why I consider it a powerful feature of Postgres.</p>
<p><em>Sources:</em></p>
<ul>
<li><em>https://www.postgresql.org/docs/9.5/sql-select.html</em></li>
</ul>
        </body>
    </html>
    